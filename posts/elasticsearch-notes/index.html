<!doctype html><html lang=en-us><head><title>Elasticsearch Notes | PinYi - Software Engineer</title><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge,chrome=1"><meta name=viewport content="width=device-width,minimum-scale=1"><meta name=description content="å› ç·£éš›æœƒä¸Šäº† Elasticsearch èª²ç¨‹ï¼ŒæŠŠè¦ºå¾—é‡è¦çš„ç­†è¨˜ä¸€ä¸‹"><meta name=generator content="Hugo 0.81.0"><meta name=ROBOTS content="NOINDEX, NOFOLLOW"><link rel=stylesheet href=/hugo.blog/css/style.css><link rel="shortcut icon" href=/hugo.blog/images/favicon.ico type=image/x-icon></head><body><nav class=navigation><a href=/hugo.blog/><span class=arrow>â†</span>Home</a>
<a href=/hugo.blog/posts>Archive</a>
<a href=/hugo.blog/tags>Tags</a>
<a href=/hugo.blog/about>About</a></nav><main class=main><section id=single><h1 class=title>Elasticsearch Notes</h1><div class=tip><time datetime="2022-07-12 10:00:00 +0800 +0800">Jul 12, 2022</time>
<span class=split>Â·</span>
<span>312 words</span>
<span class=split>Â·</span>
<span>2 minute read</span></div><div class=content><p>å› ç·£éš›æœƒä¸Šäº† Elasticsearch èª²ç¨‹ï¼ŒæŠŠè¦ºå¾—é‡è¦çš„ç­†è¨˜ä¸€ä¸‹</p><blockquote><p>æ­¤ç¯‡ç‚ºå„ç­†è¨˜ä¹‹æ•´ç†ï¼ŒéåŸå‰µå…§å®¹ï¼Œè³‡æ–™ä¾†æºå¯è¦‹æ–‡å¾Œåƒè€ƒè³‡æ–™é€£çµã€‚</p></blockquote><hr><h4 id=query-and-filter>query and filter <a href=#query-and-filter class=anchor>ğŸ”—</a></h4><ul><li>query æ ¹æ“šç›¸é—œæ€§æ¼”ç®—æ³•è¨ˆåˆ†ï¼Œä¾ç…§ç›¸é—œæ€§é«˜ä½å›å‚³</li><li>filter ä¸æ¶‰åŠè¨ˆåˆ†ï¼Œè€Œä¸” filter çš„çµæœæœƒè¢« cache èµ·ä¾†</li></ul><p><a href=https://blog.csdn.net/laoyang360/article/details/80468757 target=_blank rel=noopener>åƒè€ƒé€£çµ</a></p><hr><h4 id=inverted-index--segment-file>inverted index ã€ segment file <a href=#inverted-index--segment-file class=anchor>ğŸ”—</a></h4><ul><li>apache lucene æœƒå°‡æ¯ç­†è¢« index çš„è³‡æ–™å­˜æˆåå« inverted index çš„è³‡æ–™çµæ§‹</li><li>inverted index ä¸­æœƒå­˜æ”¾å„å€‹æ–‡ä»¶ä¸­æœ‰å‡ºç¾çš„ termsï¼Œä¸¦è¨˜éŒ„ä½ç½®ã€åç§»é‡ã€è©é »ç­‰</li><li>inverted index å¤§åˆ°ä¸€å®šç¨‹åº¦æ™‚ï¼Œæ‰å¯«æˆç‚ºä¸€å€‹ segment file</li><li>segment file ä¸æœƒå†åšä»»ä½•æ›´æ–°æˆ–è®Šå‹•ï¼Œåªä¾›è®€å–</li><li>ä¸€å€‹å¯¦éš›çš„æœå°‹å‹•ä½œï¼Œæœƒä½¿ç”¨åˆ°è¨±å¤š segment files</li></ul><hr><h4 id=update-api>update api <a href=#update-api class=anchor>ğŸ”—</a></h4><blockquote><p>ä¸¦ä¸æœƒçœŸçš„æ›´æ–°æ–‡ä»¶å…§å®¹</p></blockquote><ul><li>å¾è©²æ–‡ä»¶çš„ _source æ¬„ä½ä¸­å–å‡ºåŸå…§å®¹</li><li>å°è©² json é€²è¡Œä¿®æ”¹</li><li>å°‡èˆŠæ–‡ä»¶æ¨™ç¤ºç‚ºåˆªé™¤</li><li>ä»¥æ–°çš„ json æ–‡ä»¶å…§å®¹é‡æ–° index</li></ul><hr><h4 id=seq-no--primary-term>seq no & primary term <a href=#seq-no--primary-term class=anchor>ğŸ”—</a></h4><blockquote><p>ç”¨æ–¼ç¢ºä¿åœ¨åˆ†æ•£å¼æ¶æ§‹ä¸Š cluster å…§è³‡æ–™çš„ä¸€è‡´æ€§</p></blockquote><ul><li>_primary_termï¼šprimary shard æ”¹è®Šæ™‚+1</li><li>_seq_noï¼šæ‰€æœ‰ primary shard ä¸Šçš„ operation éƒ½+1</li><li>_versionï¼šæä¾›å¤–éƒ¨ä½¿ç”¨ä¸Šèƒ½ç¢ºä¿è³‡æ–™å­˜å–çš„é †åºæ€§</li></ul><p><a href=https://www.modb.pro/db/33685 target=_blank rel=noopener>åƒè€ƒé€£çµ</a></p><hr><h4 id=searching-request-work>searching request work <a href=#searching-request-work class=anchor>ğŸ”—</a></h4><blockquote><p>from 5, size 5<br>æœå°‹æ™‚ï¼Œå„å€‹ shard éƒ½æœƒå– 10 å€‹<br>å› æ­¤æ‹‰å› global priority queue çš„ç­†æ•¸æ˜¯ (from + size) * primary shard æ•¸é‡</p></blockquote><p>å¯ä»¥åƒè€ƒä½¿ç”¨ <a href=https://kucw.github.io/blog/2018/6/elasticsearch-scroll/ target=_blank rel=noopener>scroll</a></p><hr><h4 id=score>score <a href=#score class=anchor>ğŸ”—</a></h4><blockquote><p>è³‡æ–™å°‘ã€Shardå¤šæ™‚ï¼Œ(5å€‹Shardï¼Œ3å€‹è³‡æ–™)<br>åˆ†æ•¸æœƒå·®ç•°ä¸å¤§ï¼Œå› ç‚ºæ¯å€‹è³‡æ–™éƒ½æ˜¯å–®ä¸€Shardçš„å”¯ä¸€è³‡æ–™<br>æ„æ€æ˜¯ï¼Œåˆ†æ•¸çš„æ¯”è¼ƒï¼Œæ˜¯è·Ÿå–®ä¸€Shardç®—å‡ºä¾†çš„</p></blockquote><hr><h4 id=persistence-model>persistence model <a href=#persistence-model class=anchor>ğŸ”—</a></h4><blockquote><p>transaction log<br>1.æ¯å€‹æ“ä½œéƒ½æœƒè¢«å­˜æˆä¸€æ¢ transaction log<br>2.æ¯ä»½è¢« index çš„æ–‡ä»¶éƒ½æœƒè¢« analyzed ä¸¦å­˜åœ¨ memory buffer ä¸­<br>3.åœ¨ memory buffer ä¸­ çš„æ–‡ä»¶ä¸å¯ä»¥è¢«æœå°‹åˆ°<br>4.æ¯ 5s æŠŠ transaction log å¯«å…¥ disk</p></blockquote><blockquote><p>search refresh<br>1.æ¯ç§’åŸ·è¡Œï¼ŒåŸ·è¡Œå¾Œæ–‡ä»¶æ‰èƒ½è¢«æœå°‹åˆ°<br>2.å‘¼å« lucene flushï¼Œæ­¤æ“ä½œå°‡æŠŠ memory buffer ä¸­çš„æ–‡ä»¶å¯«å…¥ directory<br>3.ä½æ–¼ lucene directory çš„æ–‡ä»¶å¯ä»¥è¢«æœå°‹åˆ°ï¼Œä½†é‚„æ²’æœ‰ fsync åˆ°ç£ç¢Ÿä¸Š</p></blockquote><blockquote><p>search flush<br>1.é€²è¡Œ lucene commit & æ¸…ç† transaction log<br>2.lucene commit æ˜‚è²´ï¼Œé‚„æ²’ commit çš„è³‡æ–™å¯èƒ½æœƒéºå¤± (ç•¶æ©Ÿ)<br>3.å› æ­¤åˆ©ç”¨ transaction log åšä¿éšœï¼Œcommit å¾Œï¼Œtransaction log ä¹Ÿå°±å¯ä»¥æ¸…æ‰äº†</p></blockquote><blockquote><p>merge<br>1.ç•¶ segment file æ•¸é‡å¤ªå¤šï¼Œlucene æœƒé€²è¡Œ segment merge<br>2.merge æ™‚ï¼ŒåŒæ™‚æœƒç§»é™¤è¢« delete çš„æ–‡ä»¶</p></blockquote><p><a href=https://i.imgur.com/Alqjr11.jpg target=_blank rel=noopener>åƒè€ƒé€£çµ</a></p><hr><h4 id=object--nested>object & nested <a href=#object--nested class=anchor>ğŸ”—</a></h4><p>object å„²å­˜åˆ° es çš„æ™‚å€™æ˜¯è¢«å±•æ‰“å„²å­˜çš„ï¼Œå¯ä»¥æ”¹ç”¨ nested</p><pre><code>ä»¥ä¸‹æ˜¯ object ç¯„ä¾‹
PUT mytest/doc/1
{
    &quot;group&quot;: &quot;fans&quot;,
    &quot;user&quot;: [
        { &quot;first&quot;: &quot;John&quot;, &quot;last&quot;: &quot;Smith&quot; },
        { &quot;first&quot;: &quot;Alice&quot;, &quot;last&quot;: &quot;White&quot; }
    ]
}

è½‰æ›å¾Œçš„å…§éƒ¨æ–‡æª”
{
    &quot;group&quot;: &quot;fans&quot;,
    &quot;user.first&quot;: [ &quot;alice&quot;, &quot;john&quot; ],
    &quot;user.last&quot;: [ &quot;smith&quot;, &quot;white&quot; ]
}
</code></pre><p><a href=https://kucw.github.io/blog/2018/6/elasticsearch-nested/ target=_blank rel=noopener>åƒè€ƒé€£çµ</a></p><hr><h4 id=routing-paramter>routing paramter <a href=#routing-paramter class=anchor>ğŸ”—</a></h4><blockquote><p>search é è¨­è¡Œç‚ºæ˜¯ query æ‰€æœ‰çš„ node<br>ä½†æˆ‘å€‘å¯ä»¥è®“ç‰¹å®š document index æ™‚ï¼Œå°±æ”¾åœ¨æŸå° node ä¸Š<br>search æ™‚å°±ä¸éœ€ç”¨è©¢å•å…¨éƒ¨ nodes<br>å¯åœ¨å»ºç«‹ mapping æ™‚ï¼ŒæŒ‡å®šå­˜å–æ­¤ index æ™‚å¿…é ˆåœ¨åƒæ•¸æŒ‡å®š routing value</p></blockquote><hr><h4 id=expensive-queries>expensive queries <a href=#expensive-queries class=anchor>ğŸ”—</a></h4><ul><li>prex/wildcard query</li><li>fuzzy query</li><li>regexp query</li><li>script query</li><li>join query</li></ul><hr><h4 id=aggregation-request-work>aggregation request work <a href=#aggregation-request-work class=anchor>ğŸ”—</a></h4><blockquote><p>size 3<br>å› ç‚ºæ˜¯å„å€‹ shard å…ˆå– 3 å€‹ï¼Œæ”¾åˆ° global priority queue æ‰ aggregation<br>æ‰€ä»¥ aggregation æ•¸å­—æœƒå¤±æº–</p></blockquote><p>å¯ä»¥åƒè€ƒä»¥ä¸‹å…©å€‹å›å‚³å€¼</p><p>doc count error upper boundï¼Œè¡¨ç¤ºæ¯å€‹ shard å›å‚³çš„æœ€å¾Œä¸€ç­†è³‡æ–™ï¼Œæ•¸å­—çš„åŠ ç¸½<br>è‹¥æ­¤æ•¸å­—ç‚º0ï¼Œè¡¨ç¤º aggregation æ•¸å­—æ˜¯æº–çš„</p><p>sum other doc countï¼Œè¡¨ç¤ºæ¯å€‹ shardæœ‰å¤šå°‘è³‡æ–™æ²’æœ‰å›å‚³</p><hr></div><div class=tags><a href=https://pinyi-lee.github.io/hugo.blog/tags/elasticsearch>elasticsearch</a></div></section></main><footer id=footer><div class=copyright>Â© Copyright
2022
<span class=split><svg fill="#bbb" width="15" height="15" id="heart-15" xmlns="http://www.w3.org/2000/svg" width="15" height="15" viewBox="0 0 15 15"><path d="M13.91 6.75c-1.17 2.25-4.3 5.31-6.07 6.94-.1903.1718-.4797.1718-.67.0C5.39 12.06 2.26 9 1.09 6.75-1.48 1.8 5-1.5 7.5 3.45 10-1.5 16.48 1.8 13.91 6.75z"/></svg></span></div><div class=powerby>Powered by <a href=http://www.gohugo.io/>Hugo</a> Theme By <a href=https://github.com/nodejh/hugo-theme-mini>nodejh</a></div></footer></body></html>